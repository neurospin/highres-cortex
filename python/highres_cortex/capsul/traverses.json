{
    "type": "custom_pipeline",
    "name": "traverses",
    "definition": {
        "export_parameters": false,
        "doc": "Create cortical traverses. Note that there is a problem with the propagation of labels: the step size is fixed, which means that sometimes the point can skip the corner of a voxel, and thus go directly from a bulk voxel to an outside voxel. In this case it is recorded as a \"dead-end\" advection path, no resulting label is recorded and it appears as zero in the result. This problem also appears in the previous \"exchange\" step, but is mitigated by the subsequent connex component detection (each failed propagation is assigned a different label). Quick fix: fix the conjunction step to not aggregate zeros. TODO: the proper way to fix this would be to force the advection path to respect the boundaries of voxels, so that the corner of voxels cannot be skipped over. This would also prevent the advection path from crossing the thin CSF surface within the sulcus (comes from skeleton).",
        "executables": {
            "laplace": {
                "definition": "highres_cortex.capsul.processes.Laplacian",
                "type": "process"
            },
            "distmaps": {
                "definition": "highres_cortex.capsul.processes.Distmaps",
                "type": "process"
            },
            "threshold_CSF_interface": {
                "definition": "highres_cortex.capsul.processes.ImageSingleThreshold",
                "type": "process",
                "parameters": {
                    "binary": true,
                    "fg": 32767,
                    "mode": "eq",
                    "threshold": 50.0
                }
            },
            "threshold_white_interface": {
                "definition": "highres_cortex.capsul.processes.ImageSingleThreshold",
                "type": "process",
                "parameters": {
                    "binary": true,
                    "fg": 32767,
                    "mode": "eq",
                    "threshold": 150.0
                }
            },
            "label_CSF_interface": {
                "definition": "highres_cortex.capsul.processes.LabelEachVoxel",
                "type": "process",
                "parameters": {
                    "first_label": 100000001
                }
            },
            "label_white_interface": {
                "definition": "highres_cortex.capsul.processes.LabelEachVoxel",
                "type": "process",
                "parameters": {
                    "first_label": 200000001
                }
            },
            "negative_cortex": {
                "definition": "highres_cortex.capsul.processes.ImageSingleThreshold",
                "type": "process",
                "parameters": {
                    "binary": true,
                    "fg": -1,
                    "mode": "di",
                    "threshold": 100.0
                }
            },
            "negative_cortex_converter": {
                "definition": "highres_cortex.capsul.processes.ConvertDataType",
                "type": "process",
                "parameters": {
                    "data_type": "S32"
                }
            },
            "CSF_negative_cortex_merger": {
                "definition": "highres_cortex.capsul.processes.MergeImagesSameValues",
                "type": "process"
            },
            "CSF_labelled_interface_merger": {
                "definition": "highres_cortex.capsul.processes.MergeImagesAllToOne",
                "type": "process",
                "parameters": {
                    "value": 200000000.0
                }
            },
            "white_negative_cortex_merger": {
                "definition": "highres_cortex.capsul.processes.MergeImagesSameValues",
                "type": "process"
            },
            "white_labelled_interface_merger": {
                "definition": "highres_cortex.capsul.processes.MergeImagesAllToOne",
                "type": "process",
                "parameters": {
                    "value": 100000000.0
                }
            },
            "CSF_to_white_propagation": {
                "definition": "highres_cortex.capsul.processes.PropagateAlongFieldGradient",
                "type": "process",
                "parameters": {
                    "max_dist": 6.0,
                    "target_label": 200000000,
                    "upfield": true
                }
            },
            "white_to_CSF_propagation": {
                "definition": "highres_cortex.capsul.processes.PropagateAlongFieldGradient",
                "type": "process",
                "parameters": {
                    "max_dist": 6.0,
                    "target_label": 100000000,
                    "upfield": false
                }
            },
            "get_exchanged_propvol": {
                "definition": "highres_cortex.capsul.processes.GetExchangedPropagationVolume",
                "type": "process"
            },
            "merge_exchanged_on_CSF": {
                "definition": "highres_cortex.capsul.processes.MergeImagesOneToOne",
                "type": "process",
                "parameters": {
                    "label_to_replace": 150,
                    "value": 0.0
                }
            },
            "merge_exchanged_on_white": {
                "definition": "highres_cortex.capsul.processes.MergeImagesOneToOne",
                "type": "process",
                "parameters": {
                    "label_to_replace": 50,
                    "value": 0.0
                }
            },
            "CSF_on_bulk_propagation": {
                "definition": "highres_cortex.capsul.processes.PropagateAlongFieldGradient",
                "type": "process",
                "parameters": {
                    "max_dist": 6.0,
                    "target_label": 0,
                    "upfield": true
                }
            },
            "white_on_bulk_propagation": {
                "definition": "highres_cortex.capsul.processes.PropagateAlongFieldGradient",
                "type": "process",
                "parameters": {
                    "max_dist": 6.0,
                    "target_label": 0,
                    "upfield": false
                }
            },
            "relabel_conjunction": {
                "definition": "highres_cortex.capsul.processes.RelabelConjunction",
                "type": "process"
            },
            "connected_conjunction": {
                "definition": "highres_cortex.capsul.processes.ConnectedComponents",
                "type": "process",
                "parameters": {
                    "connectivity": "26"
                }
            },
            "merge_regions": {
                "definition": "highres_cortex.capsul.processes.MergeCortexColumnRegions",
                "type": "process"
            },
            "relabel": {
                "definition": "highres_cortex.capsul.processes.Relabel",
                "type": "process"
            },
            "randomize_labels": {
                "definition": "highres_cortex.capsul.processes.RandomizeLabels",
                "type": "process"
            }
        },
        "parameters": {
            "advection_step_size": 0.03,
            "goal_traverse_diameter": 0.5,
            "laplace_precision": 0.001,
            "laplace_typical_cortical_thickness": 3.0,
            "verbosity": 1
        },
        "links": [
            "classif->negative_cortex.input_image",
            "classif->merge_regions.classif",
            "classif->laplace.classif",
            "classif->distmaps.classif",
            "verbosity->white_to_CSF_propagation.verbosity",
            "verbosity->CSF_to_white_propagation.verbosity",
            "verbosity->merge_regions.verbosity",
            "verbosity->white_on_bulk_propagation.verbosity",
            "verbosity->laplace.verbosity",
            "verbosity->CSF_on_bulk_propagation.verbosity",
            "laplace_precision->laplace.precision",
            "laplace_typical_cortical_thickness->laplace.typical_cortical_thickness",
            "advection_step_size->CSF_on_bulk_propagation.step_size",
            "advection_step_size->white_on_bulk_propagation.step_size",
            "advection_step_size->CSF_to_white_propagation.step_size",
            "advection_step_size->white_to_CSF_propagation.step_size",
            "goal_traverse_diameter->merge_regions.goal_diameter",
            "laplace.laplace_field->white_to_CSF_propagation.grad_field",
            "laplace.laplace_field->CSF_on_bulk_propagation.grad_field",
            "laplace.laplace_field->white_on_bulk_propagation.grad_field",
            "laplace.laplace_field->CSF_to_white_propagation.grad_field",
            "distmaps.classif_with_outer_boundaries->merge_exchanged_on_CSF.mask_image",
            "distmaps.classif_with_outer_boundaries->get_exchanged_propvol.classif_with_outer_boundaries",
            "distmaps.classif_with_outer_boundaries->threshold_white_interface.input_image",
            "distmaps.classif_with_outer_boundaries->threshold_CSF_interface.input_image",
            "distmaps.classif_with_outer_boundaries->merge_exchanged_on_white.mask_image",
            "threshold_CSF_interface.output_image->label_CSF_interface.input_image",
            "threshold_white_interface.output_image->label_white_interface.input_image",
            "label_CSF_interface.output_image->CSF_negative_cortex_merger.mask_image",
            "label_CSF_interface.output_image->white_labelled_interface_merger.mask_image",
            "label_white_interface.output_image->CSF_labelled_interface_merger.mask_image",
            "label_white_interface.output_image->white_negative_cortex_merger.mask_image",
            "negative_cortex.output_image->negative_cortex_converter.input_image",
            "negative_cortex_converter.output_image->white_negative_cortex_merger.input_image",
            "negative_cortex_converter.output_image->CSF_negative_cortex_merger.input_image",
            "CSF_negative_cortex_merger.output_image->CSF_labelled_interface_merger.input_image",
            "CSF_labelled_interface_merger.output_image->CSF_to_white_propagation.seeds",
            "white_negative_cortex_merger.output_image->white_labelled_interface_merger.input_image",
            "white_labelled_interface_merger.output_image->white_to_CSF_propagation.seeds",
            "CSF_to_white_propagation.output_labels->get_exchanged_propvol.CSF_labels_on_white",
            "white_to_CSF_propagation.output_labels->get_exchanged_propvol.white_labels_on_CSF",
            "get_exchanged_propvol.output->merge_exchanged_on_CSF.input_image",
            "get_exchanged_propvol.output->merge_exchanged_on_white.input_image",
            "merge_exchanged_on_CSF.output_image->CSF_on_bulk_propagation.seeds",
            "merge_exchanged_on_white.output_image->white_on_bulk_propagation.seeds",
            "CSF_on_bulk_propagation.dest_points->merge_regions.proj_csf",
            "CSF_on_bulk_propagation.output_labels->relabel_conjunction.labels1",
            "white_on_bulk_propagation.dest_points->merge_regions.proj_white",
            "white_on_bulk_propagation.output_labels->relabel_conjunction.labels2",
            "relabel_conjunction.output->connected_conjunction.input_image",
            "connected_conjunction.output->merge_regions.input_traverses",
            "merge_regions.output->relabel.input",
            "relabel.output->randomize_labels.input",
            "randomize_labels.output->cortical_traverses"
        ]
    }
}
